---
description: Windows Server administration guidance for Task Scheduler, certificates, and PowerShell execution
globs: ["tools/**/*.ps1", "tasks/**/*.ps1"]
alwaysApply: false
---

# Windows Server Administration

## Task Scheduler Best Practices

### Task Configuration
1. **Run As**: Use dedicated service accounts (`app_RBACUpdate`, `app_jiraautomation`)
2. **Triggers**: Use time-based triggers for critical tasks
3. **Conditions**: Disable "Start the task only if the computer is on AC power" for servers
4. **Settings**:
   - Allow task to be run on demand: Yes
   - Run task as soon as possible after a scheduled start is missed: Yes
   - If the task fails, restart every: 1 minute, attempt restart up to: 3 times
   - Stop the task if it runs longer than: Set appropriate timeout

### Task Permissions
- Grant service account "Log on as a service" right
- Grant service account "Log on as a batch job" right
- Grant service account read/execute on script directories
- Grant service account write on log directories

### Task Monitoring
- Enable task history in Task Scheduler
- Monitor task execution in Event Viewer
- Set up PRTG alerts for task failures
- Track task execution times

## PowerShell Execution Environment

### Execution Policy
```powershell
# For scheduled tasks, use -ExecutionPolicy Bypass in task command:
pwsh.exe -ExecutionPolicy Bypass -NoProfile -File "C:\scripts\task.ps1"
```

### Module Management
1. **Install Location**: `$env:ProgramFiles\powershell\Modules`
2. **Module Versioning**: Pin module versions to avoid conflicts
3. **Module Loading**: Explicitly import modules in scripts
4. **Module Path**: Set `$PSModulePath` if needed
5. **Module Conflicts**: Use `Resolve-TAPnPPowershellConflicts` for DLL conflicts

### Profile Management
- Use `-NoProfile` flag for scheduled tasks
- Configure environment variables in task settings if needed
- Scheduled tasks typically don't load user profiles

## Certificate Management

### Certificate Installation
```powershell
# Install certificate to LocalMachine store (for service accounts)
$cert = Import-PfxCertificate `
    -FilePath "cert.pfx" `
    -CertStoreLocation "Cert:\LocalMachine\My" `
    -Password $SecurePassword

# Grant service account access to private key
$certPath = "C:\ProgramData\Microsoft\Crypto\RSA\MachineKeys\$($cert.PrivateKey.CspKeyContainerInfo.UniqueKeyContainerName)"
$acl = Get-Acl $certPath
$accessRule = New-Object System.Security.AccessControl.FileSystemAccessRule(
    "DOMAIN\ServiceAccount", "Read", "Allow"
)
$acl.SetAccessRule($accessRule)
Set-Acl $certPath $acl
```

### Certificate Monitoring
```powershell
# Check certificate expiration
$cert = Get-Item "Cert:\LocalMachine\My\25f547a3ed8a16db096757f4d296c82b3eacf628"
$daysUntilExpiry = ($cert.NotAfter - (Get-Date)).Days

if ($daysUntilExpiry -lt 30) {
    # Alert: Certificate expiring soon
}
```

### Certificate Renewal Process
1. Generate new certificate
2. Update App Registration in Azure
3. Install certificate to LocalMachine\My store
4. Update certificate permissions
5. Test authentication
6. Update scripts if thumbprint changes

## Active Directory Optimization

### Connection Management
```powershell
# Use specific domain controller for consistency
$DC = "vm-dcx-p-wus3-1.blackline.corp"
Get-ADUser -Server $DC -Identity $User
```

### Query Optimization
- Use specific filters to reduce query scope
- Limit returned properties with `-Properties`
- Use indexed attributes in filters
- Avoid wildcard searches on large domains
- Cache frequently accessed data

## OpenSSH Configuration

### Administrator SSH Keys
For administrators, keys must be in the system-wide file:
```
C:\ProgramData\ssh\administrators_authorized_keys
```
**NOT** in the user's personal `.ssh` folder.

### Set PowerShell 7 as Default Shell
```powershell
New-Item -Path "HKLM:\SOFTWARE\OpenSSH" -Force
New-ItemProperty -Path "HKLM:\SOFTWARE\OpenSSH" -Name DefaultShell `
    -Value "C:\Program Files\PowerShell\7\pwsh.exe" -PropertyType String -Force
```

## Troubleshooting Guide

### Task Not Running
1. Check Task Scheduler history
2. Verify service account permissions
3. Check Windows Event Logs (Application, System)
4. Verify PowerShell execution policy
5. Test script manually with service account
6. Check for blocking processes
7. Verify module availability

### Module Not Found
1. Check `$PSModulePath` in task context
2. Verify module installation location
3. Check module manifest
4. Test module import manually
5. Verify service account has read access
6. Check for module version conflicts

### Certificate Authentication Fails
1. Verify certificate is installed
2. Check certificate store location (LocalMachine vs CurrentUser)
3. Verify service account has private key access
4. Check certificate expiration
5. Verify App Registration configuration
6. Test certificate access manually

### AD Operations Fail
1. Verify domain controller connectivity
2. Check service account AD permissions
3. Verify AD replication status
4. Check for account lockouts
5. Verify OU paths exist
6. Test AD operations manually

## Performance Optimization

### Memory Management
- Monitor memory usage in long-running tasks
- Use `[GC]::Collect()` sparingly if needed
- Clear large variables when done
- Avoid memory leaks in loops

### Network Optimization
- Set appropriate timeouts on API calls
- Implement retry logic with exponential backoff
- Monitor network latency
